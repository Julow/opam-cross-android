From aa7bf51172dc81a36cc0df1f8d19945e7e9be92c Mon Sep 17 00:00:00 2001
From: Peter Zotov <whitequark@whitequark.org>
Date: Fri, 17 Oct 2014 08:35:59 +0400
Subject: [PATCH 4/4] Add a CROSS_COMPILING Makefile.config flag.

Use it to prevent `make checkstack` from being ran.
It is unlikely it is required on any modern system anyway.
---
 Makefile  | 5 +++--
 configure | 7 +++++++
 2 files changed, 10 insertions(+), 2 deletions(-)

diff --git a/Makefile b/Makefile
index 8a16ac5..7f35008 100644
--- a/Makefile
+++ b/Makefile
@@ -797,8 +797,9 @@ alldepend::
 # Check that the stack limit is reasonable.
 
 checkstack:
-	@if $(BYTECC) $(BYTECCCOMPOPTS) $(BYTECCLINKOPTS) \
-	              -o tools/checkstack tools/checkstack.c; \
+	@if ! $(CROSS_COMPILING) && \
+				$(BYTECC) $(BYTECCCOMPOPTS) $(BYTECCLINKOPTS) \
+	                -o tools/checkstack tools/checkstack.c; \
 	  then tools/checkstack; \
 	  else :; \
 	fi
diff --git a/configure b/configure
index 389430c..d1e9484 100755
--- a/configure
+++ b/configure
@@ -454,6 +454,7 @@ esac
 
 # Determine which ocamlrun executable to use; for cross-compilation, a native
 # "ocamlrun" executable must be available on the system.
+cross_compiling=false
 if test x"$target" != x"$host"; then
   if ! sh ./searchpath ocamlrun; then
     err "Cross-compilation requires an ocaml runtime environment\n" \
@@ -469,6 +470,7 @@ if test x"$target" != x"$host"; then
     else
       CAMLYACC="ocamlyacc"
       CAMLRUN="ocamlrun"
+      cross_compiling=true
     fi
   fi
 else
@@ -478,6 +480,7 @@ fi
 
 echo "CAMLRUN=$CAMLRUN" >> Makefile
 echo "CAMLYACC=$CAMLYACC" >> Makefile
+echo "CROSS_COMPILING=$cross_compiling" >> Makefile
 
 # Check the sizes of data types
 # OCaml needs a 32 or 64 bit architecture, a 32-bit integer type and
@@ -1724,6 +1727,10 @@ mv m.h s.h Makefile ..
 inf
 inf "** Configuration summary **"
 inf
+if $cross_compiling; then
+inf "Building a cross-compiler."
+inf
+fi
 inf "Directories where OCaml will be installed:"
 inf "        binaries.................. $bindir"
 inf "        standard library.......... $libdir"
-- 
2.1.1

